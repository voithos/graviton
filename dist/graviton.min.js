/**
 * graviton v0.3.0
 *
 * JavaScript N-body Gravitational Simulator
 *
 * Copyright (c) 2015 Zaven Muradyan
 * Licensed under the MIT license
 *
 * Revision:
 *  3501f7397389d257aaefa64cac0301f3c8a156fe
 */

define("util/lambda",{isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"},bind:function(e,t){return function(){return e.apply(t,arguments)}},foreach:function(e,t,n){var r;if(Array.prototype.forEach&&e.forEach===Array.prototype.forEach)e.forEach(t,n);else if(L.isArray(e))for(var i=0;i<e.length;i++){r=t.call(n,e[i],i,e);if(r===!1)return}else for(var s in e)if(e.hasOwnProperty(s)){r=t.call(n,e[s],s,e);if(r===!1)return}},remove:function(e,t,n){return e.splice(t,n?n:1)},addEvent:function(e,t,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent&&t.attachEvent("on"+e,n)},width:function(e){if(e===e.window)return e.document.documentElement.clientWidth;if(e.nodeType===9){var t=e.documentElement;return Math.max(e.body.scrollWidth,t.scrollWidth,e.body.offsetWidth,t.offsetWidth,t.clientWidth)}},height:function(e){if(e===e.window)return e.document.documentElement.clientHeight;if(e.nodeType===9){var t=e.documentElement;return Math.max(e.body.scrollHeight,t.scrollHeight,e.body.offsetHeight,t.offsetHeight,t.clientHeight)}}}),define("util/random",{number:function(e,t){return arguments.length===1&&(t=e,e=0),Math.random()*(t-e)+e},integer:function(){return Math.round(this.number.apply(this,arguments))},directional:function(){var e=this.number.apply(this,arguments);return Math.random()>.5&&(e=-e),e},color:function(){return"#"+("00000"+Math.floor(Math.random()*16777215).toString(16)).substr(-6)}}),define("util/log",{config:{logLevel:null},write:function(e,t){if(typeof console!="undefined"){var n=new Date,r=n.getFullYear()+"-"+n.getMonth()+"-"+n.getDate()+"T"+n.getHours()+":"+n.getMinutes()+":"+n.getSeconds()+":"+n.getMilliseconds();e=r+" "+e,t=(t||this.config.logLevel||"debug").toLowerCase();if(!console[t])throw new TypeError("Log level does not exist.");console[t](e)}},setLevel:function(e){e=e.toLowerCase();if(!console[e])throw new TypeError("Log level does not exist.");config.logLevel=e}}),define("graviton/body",[],function(){return function(e){var t={x:0,y:0,velX:0,velY:0,mass:0,radius:0,color:""};e=e||{},t.x=e.x,t.y=e.y;if(typeof t.x!="number"||typeof t.y!="number")throw new TypeError("Correct positions were not given for the body.");return t.velX=e.velX||0,t.velY=e.velY||0,t.mass=e.mass||10,t.radius=e.radius||4,t.color=e.color||"#FFFFFF",t}}),define("graviton/sim",["util/lambda","util/log","graviton/body"],function(e,t,n){return function(r){var i={options:{},bodies:[],time:0,step:function(){e.foreach(this.bodies,function(e,t){this.options.collisions===!0&&this.detectCollision(this.bodies[t],t),this.calculateNewPosition(e,t,this.options.deltaT),this.removeScattered(e,t)},this),this.time+=this.options.deltaT},calculateNewPosition:function(t,n,r){var i=0,s=0;e.foreach(this.bodies,function(e,r){if(r!==n){var o=this.calculateDistance(t,e),u=this.options.G*t.mass*e.mass/Math.pow(o.r,2),a=u*(o.dx/o.r),f=u*(o.dy/o.r);i+=a,s+=f}},this);var o=i/t.mass,u=s/t.mass;t.velX+=r*o,t.velY+=r*u,t.x+=r*t.velX,t.y+=r*t.velY},calculateDistance:function(e,t){var n={};return n.dx=t.x-e.x,n.dy=t.y-e.y,n.r=Math.sqrt(Math.pow(n.dx,2)+Math.pow(n.dy,2)),n},detectCollision:function(n,r){e.foreach(this.bodies,function(e,i){if(i!==r){var s=this.calculateDistance(n,e).r,o=n.radius+e.radius;s<=o&&t.write("Collision detected!!","debug")}},this)},removeScattered:function(t,n){if(t.x>this.options.scatterLimit||t.x<-this.options.scatterLimit||t.y>this.options.scatterLimit||t.y<-this.options.scatterLimit)return e.remove(this.bodies,n)},addNewBody:function(e){var t=n(e);return this.bodies.push(t),t},removeBody:function(t){e.remove(this.bodies,t)},clear:function(){this.bodies.length=0}};return r=r||{},i.options.G=r.G||6.67384*Math.pow(10,-11),i.options.deltaT=r.deltaT||25e3,i.options.collisions=r.collision||!0,i.options.scatterLimit=r.scatterLimit||1e4,i}}),define("graviton/gfx",[],function(){return function(e){var t={options:{},grid:null,ctx:null,clear:function(){this.grid.width=this.grid.width},drawBodies:function(e){for(var t=0;t<e.length;t++)this.drawBody(e[t])},drawBody:function(e){this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.radius,0,Math.PI*2,!0),this.ctx.fill()},drawLine:function(e){this.ctx.strokeStyle=e.strokeStyle||"#DD2222",this.ctx.beginPath(),this.ctx.moveTo(e.from.x,e.from.y),this.ctx.lineTo(e.to.x,e.to.y),this.ctx.stroke()}};e=e||{},t.options.noclear=e.noclear||!1,t.grid=typeof e.grid=="string"?document.getElementById(e.grid):e.grid,t.ctx=t.grid.getContext("2d");if(typeof t.grid=="undefined")throw new TypeError("No usable canvas element was given.");return t}}),define("graviton/events",["util/lambda","util/log"],function(e,t){return function(n){var r={keycodes:{K_LEFT:37,K_UP:38,K_RIGHT:39,K_DOWN:40,K_0:48,K_1:49,K_2:50,K_3:51,K_4:52,K_5:53,K_6:54,K_7:55,K_8:56,K_9:57,K_A:65,K_B:66,K_C:67,K_D:68,K_E:69,K_F:70,K_G:71,K_H:72,K_I:73,K_J:74,K_K:75,K_L:76,K_M:77,K_N:78,K_O:79,K_P:80,K_Q:81,K_R:82,K_S:83,K_T:84,K_U:85,K_V:86,K_W:87,K_X:88,K_Y:89,K_Z:90,K_KP1:97,K_KP2:98,K_KP3:99,K_KP4:100,K_KP5:101,K_KP6:102,K_KP7:103,K_KP8:104,K_KP9:105,K_BACKSPACE:8,K_TAB:9,K_ENTER:13,K_SHIFT:16,K_CTRL:17,K_ALT:18,K_ESC:27,K_SPACE:32},mousecodes:{M_LEFT:0,M_MIDDLE:1,M_RIGHT:2},eventcodes:{MOUSEDOWN:1e3,MOUSEUP:1001,MOUSEMOVE:1002,MOUSEWHEEL:1003,CLICK:1004,DBLCLICK:1005,KEYDOWN:1010,KEYUP:1011},queue:[],grid:null,qadd:function(e){this.queue.push(e)},qpoll:function(){return this.queue.shift()},qget:function(){var e=this.queue;return this.queue=[],e},qclear:function(){this.queue=[]},wireupEvents:function(){e.addEvent("click",this.grid,e.bind(this.handleClick,this)),e.addEvent("dblclick",this.grid,e.bind(this.handleDblClick,this)),e.addEvent("mousedown",this.grid,e.bind(this.handleMouseDown,this)),e.addEvent("mouseup",this.grid,e.bind(this.handleMouseUp,this)),e.addEvent("mousemove",this.grid,e.bind(this.handleMouseMove,this)),e.addEvent("mousewheel",this.grid,e.bind(this.handleMouseWheel,this)),e.addEvent("DOMMouseScroll",this.grid,e.bind(this.handleMouseWheel,this)),e.addEvent("keydown",document,e.bind(this.handleKeyDown,this)),e.addEvent("keyup",document,e.bind(this.handleKeyUp,this))},handleClick:function(e){this.qadd({type:this.eventcodes.CLICK,position:this.getPosition(e),button:e.button,shift:e.shiftKey,ctrl:e.ctrlKey,timestamp:e.timeStamp})},handleDblClick:function(e){t.write("Double click: "+e.button,"debug"),this.qadd({type:this.eventcodes.DBLCLICK,position:this.getPosition(e),button:e.button,shift:e.shiftKey,ctrl:e.ctrlKey,timestamp:e.timeStamp})},handleMouseDown:function(e){t.write("Mouse down: "+e.button,"debug"),this.qadd({type:this.eventcodes.MOUSEDOWN,position:this.getPosition(e),button:e.button,shift:e.shiftKey,ctrl:e.ctrlKey,timestamp:e.timeStamp})},handleMouseUp:function(e){t.write("Mouse up: "+e.button,"debug"),this.qadd({type:this.eventcodes.MOUSEUP,position:this.getPosition(e),button:e.button,shift:e.shiftKey,ctrl:e.ctrlKey,timestamp:e.timeStamp})},handleMouseMove:function(e){this.qadd({type:this.eventcodes.MOUSEMOVE,position:this.getPosition(e),timestamp:e.timeStamp})},handleMouseWheel:function(e){var n=e.wheelDelta?e.wheelDelta/120:e.detail/-3;t.write("Scroll delta: "+n,"debug"),this.qadd({type:this.eventcodes.MOUSEWHEEL,position:this.getPosition(e),wheeldelta:n,shift:e.shiftKey,ctrl:e.ctrlKey,timestamp:e.timeStamp}),e.preventDefault()},handleKeyDown:function(e){var n=e.keyCode||e.which;t.write("Key down: "+n,"debug"),this.qadd({type:this.eventcodes.KEYDOWN,keycode:n,shift:e.shiftKey,ctrl:e.ctrlKey,timestamp:e.timeStamp})},handleKeyUp:function(e){var n=e.keyCode||e.which;t.write("Key up: "+n,"debug"),this.qadd({type:this.eventcodes.KEYUP,keycode:n,shift:e.shiftKey,ctrl:e.ctrlKey,timestamp:e.timeStamp})},getPosition:function(e){return{x:e.clientX-this.grid.offsetLeft,y:e.clientY-this.grid.offsetTop}}};n=n||{};if(typeof n.grid=="undefined")throw new TypeError("No usable canvas element was given.");return r.grid=n.grid,r.wireupEvents(),r}}),define("graviton/timer",["util/lambda"],function(e){return function(t){var n={options:{},callbacks:[],running:!1,addCallback:function(t,n,r,i){r=r||this.options.defaultFps,i=i||{};var s=parseInt(1e3/r,10),o={fn:t,context:n,delay:s,intervalId:null,started:!1,nostop:i.nostop||!1};this.callbacks.push(o);if(this.running||i.autostart)o.intervalId=setInterval(e.bind(o.fn,o.context),o.delay),o.started=!0},removeCallback:function(t){e.foreach(this.callbacks,function(n,r){if(n.fn===t)return clearInterval(n.intervalId),e.remove(this.callbacks,r),!1},this)},start:function(){this.running=!0,e.foreach(this.callbacks,function(t){t.started||(t.intervalId=setInterval(e.bind(t.fn,t.context),t.delay),t.started=!0)},this)},stop:function(){this.running=!1,e.foreach(this.callbacks,function(e){e.nostop||(clearInterval(e.intervalId),e.intervalId=null,e.started=!1)},this)},toggle:function(){this.running?this.stop():this.start()}};return n.options.defaultFps=t.defaultFps||30,n}}),define("graviton/app",["util/lambda","util/random","graviton/sim","graviton/gfx","graviton/body","graviton/events","graviton/timer"],function(e,t,n,r,i,s,o){return function(i){var u={version:"0.3.0",options:{},grid:null,events:null,timer:null,sim:null,gfx:null,interaction:{},main:function(){var t=this.events.eventcodes;e.foreach(this.events.qget(),function(e){var n;switch(e.type){case t.MOUSEDOWN:this.interaction.started=!0,this.interaction.body=this.sim.addNewBody({x:e.position.x,y:e.position.y}),this.interaction.previous={x:e.position.x,y:e.position.y};break;case t.MOUSEUP:if(this.interaction.started){this.interaction.started=!1;var r=this.interaction.body;r.velX=(e.position.x-r.x)*1e-7,r.velY=(e.position.y-r.y)*1e-7}break;case t.MOUSEMOVE:this.interaction.started&&this.redrawVector({from:{x:this.interaction.body.x,y:this.interaction.body.y},to:{x:e.position.x,y:e.position.y}});break;case t.MOUSEWHEEL:break;case t.KEYDOWN:var i=this.events.keycodes;switch(e.keycode){case i.K_ENTER:this.toggle();break;case i.K_C:this.sim.clear(),this.gfx.clear(),this.timer.stop(),n=!1;break;case i.K_P:this.gfx.noclear=!this.gfx.noclear;break;case i.K_R:this.generateBodies(10,{randomColors:!0});break;case i.K_T:this.sim.addNewBody({x:this.options.width/2,y:this.options.height/2,velX:0,velY:0,mass:2e3,radius:50,color:"#5A5A5A"}),this.sim.addNewBody({x:this.options.width-400,y:this.options.height/2,velX:0,velY:25e-6,mass:1,radius:5,color:"#787878"})}}return n},this),this.redraw()},initComponents:function(){this.timer=i.timer=o(i),this.events=i.events=s(i),this.sim=n(i),this.gfx=r(i)},initTimers:function(){this.timer.addCallback(this.main,this,30,{autostart:!0,nostop:!0}),this.timer.addCallback(this.sim.step,this.sim,30)},start:function(){this.timer.start()},stop:function(){this.timer.stop()},toggle:function(){this.timer.toggle()},redraw:function(){this.gfx.clear(),this.gfx.drawBodies(this.sim.bodies)},generateGrid:function(e,t,n,r){n||(n={}),this.grid=document.createElement("canvas"),this.grid.width=e,this.grid.height=t,this.grid.style.display="block",this.grid.style.marginLeft=n.marginLeft||"auto",this.grid.style.marginRight=n.marginRight||"auto",this.grid.style.borderStyle=n.borderStyle||"solid",this.grid.style.borderWidth=n.borderWidth||"medium",this.grid.style.borderColor=n.borderColor||"#CCCCCC",this.grid.style.borderRadius=n.borderRadius||"15px",this.grid.style.backgroundColor=n.backgroundColor||"#000000",r?r.appendChild(this.grid):document.body.appendChild(this.grid)},generateBodies:function(e,n){n=n||{};var r=n.minX||0,i=n.maxX||this.options.width,s=n.minY||0,o=n.maxY||this.options.height,u=n.minVelX||0,a=n.maxVelX||1e-5,f=n.minVelY||0,l=n.maxVelY||1e-5,c=n.minMass||1,h=n.maxMass||150,p=n.minRadius||1,d=n.maxRadius||15,v=n.color;for(var m=0;m<e;m++)n.randomColors===!0&&(v=t.color()),this.sim.addNewBody({x:t.number(r,i),y:t.number(s,o),velX:t.directional(u,a),velY:t.directional(f,l),mass:t.number(c,h),radius:t.number(p,d),color:v})},redrawVector:function(e){this.eraseVector(e),this.drawVector(e),this.gfx.drawBody(this.interaction.body),this.interaction.previous=e.to},eraseVector:function(e){this.gfx.drawLine({strokeStyle:this.options.backgroundColor,from:e.from,to:this.interaction.previous})},drawVector:function(e){this.gfx.drawLine({from:e.from,to:e.to})}};return i=i||{},u.options.width=i.width||e.width(document)*.95,u.options.height=i.height||e.height(document)*.95,u.options.backgroundColor=i.backgroundColor||"#1F263B",u.grid=typeof i.grid=="string"?document.getElementById(i.grid):i.grid,typeof u.grid=="undefined"&&(u.generateGrid(u.options.width,u.options.height,{backgroundColor:u.options.backgroundColor}),i.grid=u.grid),u.initComponents(),u.initTimers(),u}}),define("graviton",["graviton/app"],function(e){return{app:e}})